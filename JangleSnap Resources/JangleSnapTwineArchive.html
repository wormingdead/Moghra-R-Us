<tw-storydata name="JangleSnap Demo" startnode="23" creator="Twine" creator-version="2.3.15" ifid="57587E33-5DB3-40C2-9EC6-46771C27ADCE" zoom="1" format="Harlowe" format-version="3.2.3" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">tw-story select {
  background-color: black;
}

tw-story {
  padding: 0% 20%;
  line-height: 1em;
}</style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-passagedata pid="1" name="03 Creature Setup" tags="startup" position="700,200" size="100,100">{=
(set: $arStatsDefault to (a:
	(dm:
		&quot;name&quot; ,&quot;Strength&quot;,
		&quot;label&quot;,&quot;STR&quot;,
		&quot;value&quot;,&quot;16&quot;
	),
	(dm:
		&quot;name&quot; ,&quot;Agility&quot;,
		&quot;label&quot;,&quot;AGI&quot;,
		&quot;value&quot;,&quot;16&quot;
	),
	(dm:
		&quot;name&quot; ,&quot;Toughness&quot;,
		&quot;label&quot;,&quot;TOU&quot;,
		&quot;value&quot;,&quot;16&quot;
	),
	(dm:
		&quot;name&quot; ,&quot;Intelligence&quot;,
		&quot;label&quot;,&quot;INT&quot;,
		&quot;value&quot;,&quot;16&quot;
	),
	(dm:
		&quot;name&quot; ,&quot;Wisdom&quot;,
		&quot;label&quot;,&quot;WIS&quot;,
		&quot;value&quot;,&quot;16&quot;
	),
	(dm:
		&quot;name&quot; ,&quot;Ego&quot;,
		&quot;label&quot;,&quot;EGO&quot;,
		&quot;value&quot;,&quot;16&quot;
	)
))

(set: $arStatValueRange to (altered: _v via (str:_v), ...(range:3,40)))

(set: $cmCreatureCreate to (macro:
	str-type _name,
	array-type _stats,
	array-type _mutations,
	array-type _cybernetics,
[
	(output-data:(dm:
		&quot;name&quot;,_name,
		&quot;stats&quot;,_stats,
		&quot;mutations&quot;,_mutations,
		&quot;cybernetics&quot;,_cybernetics
	))
]))

(set: $cmCreatureCreateDefault to (macro: str-type _name, [
	(output-data:($cmCreatureCreate:
		_name,
		$arStatsDefault,
		(a:),
		(a:)
	))
]))

(set: $cmGetStatValueMod to
(macro: datamap-type _stat, [
	(set: _v to (num:_stat&#39;s value))
	(output-data:(cond:
		_v &gt;= 16,(floor:(_v - 16) / 2),
		(ceil:(_v - 16) / 2)
	))
]))</tw-passagedata><tw-passagedata pid="2" name="10 Main Menu UI" tags="startup" position="2100,400" size="100,100">{=
(set: $r7n to $r7n + (dm:
&quot;MainMenuUI&quot;,
(macro: datamap-type _gameState, [
	(set: _cmGameUI to $r7n&#39;s GameUI)
	(set: _cmCreatureEditorUI to $r7n&#39;s CreatureEditorUI)
(output:)[
	(align:&quot;&lt;==&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		(align:&quot;=&gt;&lt;=&quot;)+
		(box:&quot;=XXXXX=&quot;)[
			#JangleSnap Demo
		] &lt;br&gt;
		&lt;br&gt;
		&#39;&#39;*TODO*&#39;&#39; Tutorial &lt;br&gt;
		&lt;br&gt;
		(link:&quot;New Game&quot;)[(replace:?Passage)[
			(_cmGameUI:_gameState)
		]] &lt;br&gt;
		&lt;br&gt;
		(link:&quot;Edit Your Character&quot;)[(replace:?Passage)[
			(_cmCreatureEditorUI:
				_gameState,
				false
			)
		]] &lt;br&gt;
		&lt;br&gt;
		(link:&quot;Edit Your Opponent&quot;)[(replace:?Passage)[
			(_cmCreatureEditorUI:
				($cmGameRotate:_gameState),
				true
			)
		]]
	]
]
])))</tw-passagedata><tw-passagedata pid="3" name="03 Game Setup" tags="startup" position="700,400" size="100,100">{=
(set: $arGamePositions to (a:
	&quot;Wanderer&quot;,
	&quot;Merchant&quot;,
	&quot;Pilgrim&quot;,
	&quot;Ascendant&quot;
))

(set: $arGameoverPositions to (a:
	&quot;Loss&quot;,
	&quot;Win&quot;
))

(set: $cmGameStateCreate to (macro:
	datamap-type _pc,
	datamap-type _npc,
[
	(output-data:(dm:
		&quot;creature&quot;,_pc,
		&quot;dice&quot;,(a:
			($cmCreateDie:&quot;Foraging&quot;),
			($cmCreateDie:&quot;Foraging&quot;)
		),
		&quot;position&quot;,1st of $arGamePositions,
		&quot;opponent&quot;,(dm:
			&quot;creature&quot;,_npc,
			&quot;dice&quot;,(a:
				($cmCreateDie:&quot;Scavenging&quot;),
				($cmCreateDie:&quot;Foraging&quot;)
			),
			&quot;position&quot;,1st of $arGamePositions
		)
	))
]))

(set: $cmGameRotate to (macro: datamap-type _gameState, [
	(move: _gameState&#39;s opponent into _newGameState)
	(output-data:_newGameState + (dm:&quot;opponent&quot;,_gameState))
]))</tw-passagedata><tw-passagedata pid="4" name="09 Player Topbar UI" tags="startup" position="1900,300" size="100,100">{=
(set: $cmPlayerTopbarUI to (macro: datamap-type _gameState, [
	(set: _pc to _gameState&#39;s creature)
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(b4r:&quot;none&quot;,&quot;none&quot;,&quot;dotted&quot;)+
	(b4r-colour:white)+
	(box:&quot;=XXXXXXX=&quot;)+
	(css:&quot;line-height:0.75em&quot;)[
		=|=
		&#39;&#39;(print:_pc&#39;s name)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 1st&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 1st&#39;s value)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 2nd&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 2nd&#39;s value)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 3rd&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 3rd&#39;s value)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 4th&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 4th&#39;s value)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 5th&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 5th&#39;s value)&#39;&#39;
		=|=
		&#39;&#39;//(print:_pc&#39;s stats&#39;s 6th&#39;s label)//&#39;&#39; &lt;br&gt;
		&#39;&#39;(print:_pc&#39;s stats&#39;s 6th&#39;s value)&#39;&#39;
		|==|
	]
]
]))</tw-passagedata><tw-passagedata pid="5" name="09 Game Board UI" tags="startup" position="1900,200" size="100,100">{=
(set: $cmGameBoardUI to (macro: datamap-type _gameState, [
	(set: _opponentState to _gameState&#39;s opponent)
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)+
	(text-size:0.75)[
		Opponent in &#39;&#39;(print:_opponentState&#39;s position)&#39;&#39; Position &lt;br&gt;
		(print:_opponentState&#39;s creature&#39;s name)&#39;s Side &gt;
	]
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		=|=
		(for: each _die, ..._gameState&#39;s dice)[
			($cmDiePrint:_die)
		]
		=|=
		(for: each _die, ..._opponentState&#39;s dice)[
			($cmDiePrint:_die)
		]
		|==|
	]
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)+
	(text-size:0.75)[
		&lt; Your Side &lt;br&gt;
		You are in &#39;&#39;(print:_gameState&#39;s position)&#39;&#39; Position
	]
]
]))</tw-passagedata><tw-passagedata pid="6" name="09 Player Choice UI" tags="startup" position="1900,400" size="100,100">{=
(set: $cmPlayerChoiceUI to (macro: datamap-type _gameState, [
(output:)[
	(align:&quot;&lt;==&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		=|=
		(align:&quot;=&gt;&lt;=&quot;)+
		(box:&quot;=XXXXX=&quot;)[
			###Standard Actions
		]
		(for: each _choice, ...($cmChoiceFilter:
			_gameState,
			$arRollChoiceRules,
		))[
			($cmChoiceLinkCreate:_gameState,_choice)
		]
		=|=
		(align:&quot;=&gt;&lt;=&quot;)+
		(box:&quot;=XXXXX=&quot;)[
			###Ability Actions
		]
		|==|
	]
]
]))</tw-passagedata><tw-passagedata pid="7" name="03 Dice Setup" tags="startup" position="700,300" size="100,100">{=
(set: $numDiceID to -1)

(set: $arDieSidesScavenging to
(a:
	&quot;Turret&quot;   ,
	&quot;Moghra&#39;Yi&quot;,
	&quot;Shrine&quot;   ,
	&quot;Spindle&quot;
))

(set: $arDieSidesForaging to
(a:
	&quot;Young Ivory&quot;,
	&quot;Brinestalk&quot; ,
	&quot;Water Dram&quot; ,
	&quot;Brinestalk&quot; ,
	&quot;Water Dram&quot; ,
	&quot;Tonic&quot;
))

(set: $arGameDiceHands to (a:
	&quot;Foraging&quot;,
	&quot;Scavenging&quot;
))

(set: $dmAbstractDie to (dm:
	&quot;colour&quot; ,transparent,
	&quot;effects&quot;,(a:),
	&quot;id&quot;     ,-1,
	&quot;kind&quot;   ,&quot;&quot;,
	&quot;sides&quot;  ,(a:),
	&quot;value&quot;  ,&quot;&quot;
))

(set: $cmCreateDie to (macro: str-type _dieKind, [
	(set: $numDiceID to $numDiceID + 1)
	(output-data:
		(cond:
			_dieKind is &quot;Scavenging&quot;,
				$dmAbstractDie
				+ (dm:&quot;colour&quot;,red)
				+ (dm:&quot;id&quot;    ,$numDiceID)
				+ (dm:&quot;kind&quot;  ,&quot;Scavenging&quot;)
				+ (dm:&quot;sides&quot; ,$arDieSidesScavenging)
			,
			_dieKind is &quot;Foraging&quot;,
				$dmAbstractDie
				+ (dm:&quot;colour&quot;,grey)
				+ (dm:&quot;id&quot;    ,$numDiceID)
				+ (dm:&quot;kind&quot;  ,&quot;Foraging&quot;)
				+ (dm:&quot;sides&quot; ,$arDieSidesForaging)
		)
	)
]))

(set: $cmDiePrint to (macro: datamap-type _die, [
(output:)+
(text-colour:_die&#39;s colour)[
	(cond:
		_die&#39;s value is &quot;&quot;,&quot;&quot;,
		_die&#39;s kind + &quot; result: &quot; + _die&#39;s value
	)
]
]))

(set: $cmDiceHandOpposite to (macro: str-type _diceHand, [
	(output-data:(cond:
		_diceHand is 1st of $arGameDiceHands,2nd of $arGameDiceHands
		_diceHand is 2nd of $arGameDiceHands,1st of $arGameDiceHands
	))
]))

(set: $cmGetDiceHand to (macro: array-type _dice, [
	(output-data:(cond:
		(find:
			_die where _die&#39;s kind is &quot;Scavenging&quot;,
			..._dice
		)&#39;s length &gt; 0,
			2nd of $arGameDiceHands,
		1st of $arGameDiceHands
	))
]))

(set: $cmDieResult to (macro: datamap-type _die, [
	(output-data:_die&#39;s value)
]))

(set: $cmDiceResult to (macro: array-type _dice, [
	(output-data:(altered:_die via ($cmDieResult:_die), ..._dice))
]))</tw-passagedata><tw-passagedata pid="8" name="02 Foraging Wanderer Roll Results" tags="startup" position="450,425" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;FW Loss&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Young Ivory&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FW Become Merchant&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Water Dram&quot;,&quot;Water Dram&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Merchant&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FW No Change&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Young Ivory&quot;,&quot;Water Dram&quot;),
		(a:&quot;Young Ivory&quot;,&quot;Tonic&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Tonic&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Tonic&quot;),
		(a:&quot;Tonic&quot; ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="9" name="02 Scavenging Wanderer Rolls Results" tags="startup" position="550,525" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;SW Loss&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Turret&quot;,&quot;Water Dram&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SW Become Pilgrim&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Shrine&quot;,&quot;Brinestalk&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Pilgrim&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SW Become Ascendant&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Spindle&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Ascendant&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SW No Change&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Turret&quot; ,&quot;Tonic&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Water Dram&quot;),
		(a:&quot;Shrine&quot; ,&quot;Young Ivory&quot;),
		(a:&quot;Shrine&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Shrine&quot; ,&quot;Tonic&quot;),
		(a:&quot;Spindle&quot; ,&quot;Young Ivory&quot;),
		(a:&quot;Spindle&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Spindle&quot; ,&quot;Water Dram&quot;)
	),
	&quot;positions&quot;,(a:&quot;Wanderer&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="10" name="02 Foraging Merchant Roll Results" tags="" position="450,625" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;FM Win&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Water Dram&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Tonic&quot;),
		(a:&quot;Tonic&quot;      ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FM Loss&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Young Ivory&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FM Become Wanderer&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Young Ivory&quot;,&quot;Tonic&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FM Become Wanderer w/ Merchant Swap&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Brinestalk&quot;,&quot;Brinestalk&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;opponent&quot;,(dm:
		&quot;positions&quot;,(a:&quot;Wanderer&quot;)
	),
	&quot;priority&quot;,-4,
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;,
		&quot;opponent&quot;,(dm:
			&quot;position&quot;,&quot;Merchant&quot;
		)
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FM Become Wanderer wo/ Merchant Swap&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Brinestalk&quot;,&quot;Brinestalk&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;opponent&quot;,(dm:
		&quot;positions&quot;,(a:&quot;Merchant&quot;,&quot;Pilgrim&quot;,&quot;Ascendant&quot;)
	),
	&quot;priority&quot;,-4,
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="11" name="02 Scavenging Merchant Roll Results" tags="" position="550,725" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;SM Win&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Water Dram&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SM Loss&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Turret&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Brinestalk&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SM Become Wanderer&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;,&quot;Water Dram&quot;),
		(a:&quot;Turret&quot;,&quot;Tonic&quot;),
		(a:&quot;Shrine&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Shrine&quot;,&quot;Tonic&quot;),
		(a:&quot;Spindle&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Spindle&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Spindle&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SM Become Pilgrim&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Shrine&quot;,&quot;Brinestalk&quot;)
	),
	&quot;positions&quot;,(a:&quot;Merchant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Pilgrim&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="12" name="02 Foraging Pilgrim Roll Results" tags="" position="450,825" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;FP Win&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Tonic&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Tonic&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FP Loss&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Young Ivory&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FP Become Wanderer&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Brinestalk&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Water Dram&quot;,&quot;Water Dram&quot;),
		(a:&quot;Tonic&quot; ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FP No Change&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Young Ivory&quot;,&quot;Water Dram&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Water Dram&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Pilgrim&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="13" name="02 Scavenging Pilgrim Roll Results" tags="" position="550,925" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;SP Win&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Tonic&quot;),
		(a:&quot;Shrine&quot;,&quot;Water Dram&quot;),
		(a:&quot;Shrine&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SP Loss&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Shrine&quot;,&quot;Young Ivory&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SP Become Wanderer&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Turret&quot; ,&quot;Tonic&quot;),
		(a:&quot;Spindle&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Spindle&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Spindle&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Wanderer&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SP No Change&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;,&quot;Water Dram&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Water Dram&quot;),
		(a:&quot;Shrine&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Spindle&quot; ,&quot;Water Dram&quot;)
	),
	&quot;positions&quot;,(a:&quot;Pilgrim&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Pilgrim&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="14" name="02 Foraging Ascendant Roll Results" tags="" position="450,1025" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;FA Win&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Tonic&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Tonic&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FA Loss&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Tonic&quot;      ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;FA No Change&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Young Ivory&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Young Ivory&quot;,&quot;Water Dram&quot;),
		(a:&quot;Brinestalk&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Water Dram&quot; ,&quot;Water Dram&quot;),
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Ascendant&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="15" name="02 Scavenging Ascendant Roll Results" tags="" position="550,1125" size="100,100">{=
(set: $arResultRules to $arResultRules + (a:
(dm:
	&quot;ruleName&quot;,&quot;SA Win&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot;   ,&quot;Tonic&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Water Dram&quot;),
		(a:&quot;Moghra&#39;Yi&quot;,&quot;Tonic&quot;),
		(a:&quot;Shrine&quot;   ,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Win&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SA Loss&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot; ,&quot;Young Ivory&quot;),
		(a:&quot;Turret&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Spindle&quot;,&quot;Young Ivory&quot;),
		(a:&quot;Spindle&quot;,&quot;Brinestalk&quot;),
		(a:&quot;Spindle&quot;,&quot;Tonic&quot;)
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Loss&quot;
	)
),

(dm:
	&quot;ruleName&quot;,&quot;SA No Change&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;diceResults&quot;,(a:
		(a:&quot;Turret&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Shrine&quot; ,&quot;Young Ivory&quot;),
		(a:&quot;Shrine&quot; ,&quot;Brinestalk&quot;),
		(a:&quot;Shrine&quot; ,&quot;Water Dram&quot;),
		(a:&quot;Spindle&quot;,&quot;Water Dram&quot;)
	),
	&quot;positions&quot;,(a:&quot;Ascendant&quot;),
	&quot;effects&quot;,(dm:
		&quot;position&quot;,&quot;Ascendant&quot;
	)
)

))</tw-passagedata><tw-passagedata pid="16" name="01 Recursion Setup" tags="startup" position="300,200" size="100,100">{=
&lt;!--
Harlowe doesn&#39;t support recursion by default, as variable names are not bound until after the declaration block is checked for correctness. This means that macros cannot refer to themselves and that macro declared earlier cannot refer to macros declared later, due to strict ordering of declarations (and startup pages).

However, macros can be stored in data structures and then referred to indirectly. This indirection means that macros can call themselves in their declaration.

For example, suppose you want to implement the factorial (!) function recursively.

(set: _factorial to
(macro: num-type _num)[
	(if:_num &lt; 1)[(output-data: 1)]
	(else:)[(output-data: _num * (_factorial: _num - 1))]
]))

This code will error because &quot;_factorial&quot; does not yet have a value in the macro declaration block. We can fix this by creating a global datamap to store the macro and referencing it in the declaration.

(set: $recursion to
(dm:
	&quot;factorial&quot;,(macro: num-type _num)[
		(set: _factorial to $recursion&#39;s factorial)
		(if: _num &lt; 1)[(output-data: 1)]
		(else:)[(output-data: _num * (_factorial: _num - 1))]
	]
))
(set: _cm to $recursion&#39;s factorial)
(print: (_cm: 4))

&gt; 24

--&gt;

(set: $r7n to (dm:))</tw-passagedata><tw-passagedata pid="17" name="02 Choice Rules" tags="startup" position="500,200" size="100,100">{=
(set: $arRollChoiceRules to (a:
(dm:
	&quot;ruleName&quot;,&quot;Foraging NoCheat&quot;,
	&quot;ruleKind&quot;,&quot;Standard&quot;,
	&quot;diceHand&quot;,&quot;Foraging&quot;,
	&quot;positions&quot;,(a:&quot;Wanderer&quot;,&quot;Merchant&quot;,&quot;Pilgrim&quot;,&quot;Ascendant&quot;),
	&quot;mutations&quot;,(a:),
	&quot;cybernetics&quot;,(a:),
	&quot;diceStates&quot;,(a:&quot;NoEffect&quot;),
	&quot;effects&quot;,(dm:
			&quot;rollType&quot;,&quot;fairRoll&quot;,
			&quot;diceKind&quot;,&quot;Foraging&quot;,
			&quot;opponent&quot;,(dm:
				&quot;rollType&quot;,&quot;fairRoll&quot;,
				&quot;diceKind&quot;,&quot;Foraging&quot;
			)
	),
	&quot;description&quot;,&quot;Roll Foraging die in each area&quot;
),

(dm:
	&quot;ruleName&quot;,&quot;Pass Scavenging NoCheat&quot;,
	&quot;ruleKind&quot;,&quot;Standard&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;positions&quot;,(a:&quot;Wanderer&quot;,&quot;Merchant&quot;,&quot;Pilgrim&quot;,&quot;Ascendant&quot;),
	&quot;mutations&quot;,(a:),
	&quot;cybernetics&quot;,(a:),
	&quot;diceStates&quot;,(a:&quot;NoEffect&quot;),
	&quot;effects&quot;,(dm:
			&quot;rollType&quot;,&quot;fairRoll&quot;,
			&quot;diceKind&quot;,&quot;Foraging&quot;,
			&quot;opponent&quot;,(dm:
				&quot;rollType&quot;,&quot;fairRoll&quot;,
				&quot;diceKind&quot;,&quot;Scavenging&quot;
			)
	),
	&quot;description&quot;,&quot;Pass Scavenging die, roll Foraging&quot;
),

(dm:
	&quot;ruleName&quot;,&quot;Keep Scavenging NoCheat&quot;,
	&quot;ruleKind&quot;,&quot;Standard&quot;,
	&quot;diceHand&quot;,&quot;Scavenging&quot;,
	&quot;positions&quot;,(a:&quot;Wanderer&quot;,&quot;Merchant&quot;,&quot;Pilgrim&quot;,&quot;Ascendant&quot;),
	&quot;mutations&quot;,(a:),
	&quot;cybernetics&quot;,(a:),
	&quot;diceStates&quot;,(a:&quot;NoEffect&quot;),
	&quot;effects&quot;,(dm:
			&quot;rollType&quot;,&quot;fairRoll&quot;,
			&quot;diceKind&quot;,&quot;Scavenging&quot;,
			&quot;opponent&quot;,(dm:
				&quot;rollType&quot;,&quot;fairRoll&quot;,
				&quot;diceKind&quot;,&quot;Foraging&quot;
			)
	),
	&quot;description&quot;,&quot;Keep Scavenging, pass Foraging die&quot;
)

))</tw-passagedata><tw-passagedata pid="18" name="03 Roll Choice Setup" tags="startup" position="700,600" size="100,100">{=
(set: $cmRollOddsCalc to (macro:
	datamap-type _creature,
	datamap-type _choiceRule,
[
	(output-data:(folded:
		_effect making _odds via (cond:
			_effect&#39;s rollType is &quot;fairRoll&quot;,
				($cmFairRollCalc:_creature) * _odds,
			0
		),
		1.0,
		_choiceRule&#39;s effects,
		_choiceRule&#39;s effects&#39;s opponent
	))
]))

(set: $cmChoiceFilter to (macro:
	datamap-type _gameState,
	array-type _arRollChoiceRules,
[
	(output-data:(find:
		_choice where
			_choice&#39;s diceHand is ($cmGetDiceHand:_gameState&#39;s dice)
			and _gameState&#39;s position is in _choice&#39;s positions
			and ($cmRollOddsCalc:_gameState&#39;s creature,_choice) &gt; 0,
		..._arRollChoiceRules
	))
]))</tw-passagedata><tw-passagedata pid="19" name="06 Roll Choice Application" tags="startup" position="1300,200" size="100,100">{=
(set: $cmRollEffects to (macro:
	datamap-type _creature,
	datamap-type _choiceE,
	datamap-type _die,
[
	(output-data:(cond:
		_choiceE&#39;s rollType is &quot;fairRoll&quot;,
			($cmFairRollEffect:_creature,_die),
		_choiceE&#39;s rollType is &quot;&quot;,
			(dm:)
	))
]))

(set: $cmRollChoiceApp to (macro:
	datamap-type _gameState,
	datamap-type _choiceE,
[
	(set: _creature to _gameState&#39;s creature)
	(move: _choiceE&#39;s opponent into _choiceEOpp)
	(set: _dice to _gameState&#39;s dice)
	
	(set: _playerDie to (find:
		_die where _die&#39;s kind is _choiceE&#39;s diceKind,
		..._dice
	)&#39;s 1st)
	(set: _dice to _dice - (a:_playerDie))
	
	(set: _oppDie to (find:
		_die where _die&#39;s kind is _choiceEOpp&#39;s diceKind,
		..._dice
	)&#39;s 1st)
	(set: _result to ($cmRollEffects:
		_creature,
		_choiceE,
		_playerDie
	))
	(set: _resultOpp to ($cmRollEffects:
		_creature,
		_choiceEOpp,
		_oppDie
	))
	
	(output-data:(dm:
		&quot;dice&quot;,(a:_result&#39;s die),
		&quot;success&quot;,_result&#39;s success and _resultOpp&#39;s success,
		&quot;opponent&quot;,(dm:
			&quot;dice&quot;,(a:_resultOpp&#39;s die)
		)
	))
]))

(set: $cmDiceStateCombine to (macro:
	datamap-type _gameState,
	datamap-type _diceState1,
	datamap-type _diceState2,
[
	(output-data:
		_gameState + (dm:
			&quot;dice&quot;,
				_diceState1&#39;s dice
				+ _diceState2&#39;s dice,
			&quot;opponent&quot;,_gameState&#39;s opponent + (dm:
				&quot;dice&quot;,
					_diceState1&#39;s opponent&#39;s dice
					+ _diceState2&#39;s opponent&#39;s dice
			)
		)
	)
]))

(set: $cmRollChoiceApply to (macro:
	datamap-type _gameState,
	datamap-type _pcChoice,
	datamap-type _npcChoice,
[
	(set: _pcDiceState to ($cmRollChoiceApp:
		_gameState,
		_pcChoice&#39;s effects
	))
	(move: _pcDiceState&#39;s success into _pcSuccess)
	(set: _npcDiceState to ($cmRollChoiceApp:
		($cmGameRotate:_gameState),
		_npcChoice&#39;s effects
	))
	(move: _npcDiceState&#39;s success into _npcSuccess)
	(set: _gameState to ($cmDiceStateCombine:
		_gameState,
		_pcDiceState,
		($cmGameRotate:_npcDiceState)
	))
(output:)[
	(if: not (_pcSuccess and _npcSuccess))[
		($cmGameOverUI:
			_gameState,
			(dm:
				&quot;endKind&quot;,&quot;roll&quot;,
				&quot;pcChoice&quot;,_pcChoice,
				&quot;pcSuccess&quot;,_pcSuccess,
				&quot;npcChoice&quot;,_npcChoice,
				&quot;npcSuccess&quot;,_npcSuccess
			)
		)
	](else:)[
		($cmRollResultApply:
			_gameState,
			($cmResultFilter:
				_gameState,
				$arResultRules
			)&#39;s 1st,
			($cmResultFilter:
				($cmGameRotate:_gameState),
				$arResultRules
			)&#39;s 1st
		)
	]
]
]))</tw-passagedata><tw-passagedata pid="20" name="10 Creature Editor UI" tags="startup" position="2100,200" size="100,100">{=
(set: $r7n to $r7n + (dm:
&quot;CreatureEditorUI&quot;,
(macro:
	datamap-type _gameState,
	bool-type _rotate,
[
	(set: _cmMainMenuUI to $r7n&#39;s MainMenuUI)
	(set: _creature to _gameState&#39;s creature)
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=X=&quot;)[
		=|=
		(link:&quot;Save &amp; Return&quot;)[(replace:?Passage)[
			(_cmMainMenuUI:(cond:
				_rotate,($cmGameRotate:
					_gameState + (dm:&quot;creature&quot;,_creature)),
				_gameState + (dm:&quot;creature&quot;,_creature)
			))
		]]
		=|=
		(link:&quot;Cancel&quot;)[(replace:?Passage)[
			(_cmMainMenuUI:(cond:
				_rotate,($cmGameRotate:_gameState),
				_gameState
			))
		]]
		|==|
	]

	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXX=&quot;)[
		###Information
		=|=
		&#39;&#39;//Name//&#39;&#39;
		=|=
		(input-box:2bind _creature&#39;s name,&quot;X&quot;,1)
		|==|
	]

	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXX=&quot;)[
		###Attributes
		=|=
		(for: each _stat, ..._creature&#39;s stats)[
			&#39;&#39;//(print:_stat&#39;s name)//&#39;&#39; &lt;br&gt;
		]
		=|=
		(for: each _i, ...(range:1,_creature&#39;s stats&#39;s length))[
			(dropdown:
				2bind _creature&#39;s stats&#39;s (_i)&#39;s value,
				...$arStatValueRange
			) &lt;br&gt;
		]
		|==|
	]

	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		=|=
		###Mutations
		(align:&quot;&lt;==&quot;)+
		(box:&quot;=XXX=&quot;)[
			* //Todo//
		]
		=|=
		###Cybernetics
		(align:&quot;&lt;==&quot;)+
		(box:&quot;=XXX=&quot;)[
			* //Todo//
		]
		|==|
	]

	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=X=&quot;)[
		=|=
		(link:&quot;Save &amp; Return&quot;)[(replace:?Passage)[
			(_cmMainMenuUI:(cond:
				_rotate,($cmGameRotate:
					_gameState + (dm:&quot;creature&quot;,_creature)),
				_gameState + (dm:&quot;creature&quot;,_creature)
			))
		]]
		=|=
		(link:&quot;Cancel&quot;)[(replace:?Passage)[
			(_cmMainMenuUI:(cond:
				_rotate,($cmGameRotate:_gameState),
				_gameState
			))
		]]
		|==|
	]
]
])))</tw-passagedata><tw-passagedata pid="21" name="10 Game UI" tags="startup" position="2100,300" size="100,100">{=
(set: $r7n to $r7n + (dm:
&quot;GameUI&quot;,
(macro: datamap-type _gameState, [
(output:)[
	($cmPlayerTopbarUI: _gameState)
	($cmGameBoardUI: _gameState)
	($cmPlayerChoiceUI: _gameState)
]
])))</tw-passagedata><tw-passagedata pid="22" name="Notes: Game Loop" tags="" position="100,200" size="100,100">{=
&lt;!--
Core Game Loop:

1. Display game board
	- Display Player Roll Choices
2. Perform both dice rolls
	- Calculate NPC roll
3. Apply Dice Roll Result Rules
	- Examine results, then apply result effects
4. Check for game completion
	- Check for ties
5a. If either player has won, lost, or tied, go to ending screen
	- Use (replace: ?Passage) to get rid of old UI
5b. Loop back to #1
	- Use (replace: ?Passage) to get rid of old UI
--&gt;
</tw-passagedata><tw-passagedata pid="23" name="Main" tags="" position="100,100" size="100,100">{=
(set: _cmMainMenuUI to $r7n&#39;s MainMenuUI)
(replace:?Passage)[(_cmMainMenuUI:($cmGameStateCreate:
	($cmCreatureCreateDefault:&quot;Traveler&quot;),
	($cmCreatureCreateDefault:&quot;Kiuun Kiqat, Snapjaw Hunter&quot;)
))]</tw-passagedata><tw-passagedata pid="24" name="08 Roll Choice Link Setup" tags="startup" position="1700,200" size="100,100">{=
(set: $cmChoiceLinkCreate to (macro:
	datamap-type _gameState,
	datamap-type _choiceRule,
[
	(set: _pc to _gameState&#39;s creature)
	(set: _odds to (round:($cmRollOddsCalc:_pc,_choiceRule) * 100))
	(set: _oddsStr to (cond:
		_odds &lt; 100, &quot; &#96;[&#96;&quot; + (str:_odds) + &quot;%&#96;]&#96;&quot;,
		&quot;&quot;
	))

(output:)[
	(link:_choiceRule&#39;s description + _oddsStr)[
		(replace:?Passage)[
			($cmGameTurn:_gameState,_choiceRule)
		]
	]
]
]))</tw-passagedata><tw-passagedata pid="25" name="Notes: Better Passing of GameState" tags="" position="100,300" size="100,100">&lt;!--
There&#39;s a few places where &#96;gameState&#96; and a &#96;creature&#96; are passed, and a way to remove the redundancy would be to make gameState a zipper-type structure, focused on the creature. Rotating &#96;gameState&#96; could be done with an &#39;opponent&#39; key.
Not sure it&#39;s worth doing at this point, though.

I did it anyway.
--&gt;</tw-passagedata><tw-passagedata pid="26" name="07 Game Turn Setup" tags="startup" position="1500,200" size="100,100">{=
(set: $cmGameTurn to (macro:
	datamap-type _gameState,
	datamap-type _pcChoice,
[
	(set: _npcChoice to ($cmAIRollChoice:($cmGameRotate:_gameState)))
(output:)[
	($cmRollChoiceApply:_gameState,_pcChoice,_npcChoice)
]
]))</tw-passagedata><tw-passagedata pid="27" name="02 Fair Roll Implementation" tags="startup" position="500,300" size="100,100">{=
(set: $cmFairRollCalc to (macro: datamap-type _creature, [
	(set: _agiM to ($cmGetStatValueMod:
		1st of (find:
			_stat where _stat&#39;s label is &quot;AGI&quot;,
			..._creature&#39;s stats
		)
	))
	(output-data:(cond:
		_agiM &gt;= 1, 1.0,
		(6 + _agiM) * (6 + _agiM) / (6 * 6 + 1)
		+ 2 / 3 * (1.0 - (6 + _agiM) * (6 + _agiM) / (6 * 6 + 1))
	))
]))

(set: $cmFairRollEffect to (macro:
	datamap-type _creature,
	datamap-type _die,
[
	(set: _success to
		(random:1,100) &lt;= (round:($cmFairRollCalc:_creature) * 100)
	)
	(output-data:(dm:
		&quot;die&quot;,_die + (dm:&quot;value&quot;,(either: ..._die&#39;s sides)),
		&quot;success&quot;,_success
	))
]))</tw-passagedata><tw-passagedata pid="28" name="04 NPC AI" tags="startup" position="900,300" size="100,100">{=
(set: $cmAIRollChoice to (macro: datamap-type _gameState, [
	(output-data:(either: ...($cmChoiceFilter:
		_gameState,
		$arRollChoiceRules
	)))
]))</tw-passagedata><tw-passagedata pid="29" name="04 Game Over UI" tags="startup" position="900,200" size="100,100">{=
(set: $cmGameoverMessageRoll to (macro: datamap-type _message, [
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		(box:&quot;=XXXXX=&quot;)[
			(if: not (_message&#39;s pcSuccess or _message&#39;s npcSuccess))[
				##You have tied
			](else-if: not _message&#39;s pcSuccess)[
				##You have lost
			](else-if: not _message&#39;s npcSuccess)[
				##You have won!
			]
		]
		(if: not _message&#39;s pcSuccess)[
			You fumbled your (print:_message&#39;s pcChoice&#39;s ruleName) roll.
			&lt;br&gt;
		]
		(if: not _message&#39;s npcSuccess)[
			Your opponent fumbled their (print:_message&#39;s npcChoice&#39;s ruleName) roll.
			&lt;br&gt;
		]
	]
]
]))

(set: $cmGameoverMessageResult to (macro: datamap-type _message, [
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXXXX=&quot;)[
		(box:&quot;=XXXXX=&quot;)[
			(if:_message&#39;s pcPosition is _message&#39;s npcPosition)[
				##You have tied
			](else-if:_message&#39;s pcPosition is $arGameoverPositions&#39;s 1st
				or _message&#39;s npcPosition is $arGameoverPosition&#39;s 2nd
			)[
				##You have lost
			](else-if:_message&#39;s pcPosition is $arGameoverPosition&#39;s 2nd
				or _messagen&#39;s npcPosition is $arGameoverPosition&#39;s 1st
			)[
				##You have won!
			]
		]
		Your roll resulted in (print:_message&#39;s pcResult&#39;s ruleName).
		&lt;br&gt;
		Your opponent&#39;s roll resulted in (print:_message&#39;s npcResult&#39;s ruleName).
		&lt;br&gt;
	]
]
]))

(set: $cmGameoverMenuCreate to (macro: datamap-type _gameState, [
	(set: _cmGameUI to $r7n&#39;s GameUI)
	(set: _cmMainMenuUI to $r7n&#39;s MainMenuUI)
(output:)[
	(align:&quot;=&gt;&lt;=&quot;)+
	(box:&quot;=XXXXX=&quot;)[
		=|=
		(link:&quot;New Game&quot;)[(replace:?Passage)[
			(_cmGameUI:($cmGameStateCreate:
				_gameState&#39;s creature,
				_gameState&#39;s opponent&#39;s creature
			))
		]]
		=|=
		(link:&quot;Main Menu&quot;)[(replace:?Passage)[
			(_cmMainMenuUI:($cmGameStateCreate:
				_gameState&#39;s creature,
				_gameState&#39;s opponent&#39;s creature
			))
		]]
		|==|
	]
]
]))

(set: $cmGameOverUI to (macro:
	datamap-type _gameState,
	datamap-type _gameoverMessage,
[
(output:)[
	($cmPlayerTopbarUI:_gameState)
	(if:_gameoverMessage&#39;s endKind is &quot;roll&quot;)[
		($cmGameoverMessageRoll:_gameoverMessage)
	](else-if:_gameoverMessage&#39;s endKind is &quot;result&quot;)[
		($cmGameoverMessageResult:_gameoverMessage)
	]
	($cmGameoverMenuCreate:_gameState)
]
]))</tw-passagedata><tw-passagedata pid="30" name="03 Roll Result Setup" tags="startup" position="700,700" size="100,100">{=
(set: $cmDEBUG1 to (macro: any-type _a, [
	(set: $DEBUG1 to _a)
	(output-data:_a)
]))

(set: $cmDEBUG2 to (macro: any-type _a, [
	(set: $DEBUG2 to _a)
	(output-data:_a)
]))

(set: $r7n to $r7n + (dm:
&quot;ResultCheck&quot;,
(macro:
	datamap-type _gameState,
	datamap-type _rule,
[
	($cmDEBUG2:_rule)
	(set: _cmResultCheck to $r7n&#39;s ResultCheck)
	(output-data:(folded:
		_ruleField making _match via _match and (cond:
			_ruleField&#39;s name is &quot;positions&quot;,
				_gameState&#39;s position is in _ruleField&#39;s value,
			_ruleFields&#39;s name is &quot;diceHand&quot;,
				($cmGetDiceHand:_gameState&#39;s dice) is _ruleField&#39;s value,
			_ruleField&#39;s name is &quot;diceResults&quot;,
				(sorted:($cmDiceResults:_gameState&#39;s dice))
					is in _ruleField&#39;s value,
			_ruleField&#39;s name is &quot;opponent&quot;,
				(_cmResultCheck:
					($cmGameRotate:_gameState),
					_ruleField&#39;s value
				),
			true
		),
		true,
		...(dataentries:_rule)
	))
])))

&lt;!--
ResultFilter doesn&#39;t handle result rules with &quot;priority&quot; fields correctly yet.
--&gt;
(set: $cmResultFilter to (macro:
	datamap-type _gameState,
	array-type _resultRules,
[
	(set: _cmResultCheck to $r7n&#39;s ResultCheck)
	(output-data:(find:
		_rule where (_cmResultCheck:_gameState,($cmDEBUG1:_rule)),
		..._resultRules
	))
]))</tw-passagedata><tw-passagedata pid="31" name="05 Roll Result Application" tags="startup" position="1100,200" size="100,100">{=
(set: $r7n to $r7n + (dm:
&quot;RollResultApp&quot;,
(macro:
	datamap-type _gameState,
	datamap-type _ruleE,
[
	(set: _cmRollResultApp to $r7n&#39;s RollResultApp)
	(output-data:(folded:
		_effectField making _newGameState via (cond:
			_effectField&#39;s name is &quot;position&quot;,
				_newGameState + (dm:&quot;position&quot;,_effectField&#39;s value),
			_effectField&#39;s name is &quot;opponent&quot;,
				($cmGameRotate:(_cmRollResultApp:($cmGameRotate:
					_newGameState,
					_effectField&#39;s value
				))),
			_newGameState
		),
		_gameState,
		...(dataentries:_ruleE)
	))
])))

(set: $cmRollResultApply to (macro:
	datamap-type _gameState,
	datamap-type _pcResultRule,
	datamap-type _npcResultRule,
[
	(set: _cmRollResultApp to $r7n&#39;s RollResultApp)
	(set: _cmGameUI to $r7n&#39;s GameUI)
	(if:_pcResultRule does not contain &quot;priority&quot;)[
		(set: _pcResultRule&#39;s priority to 0)
	]
	(if:_npcResultRule does not contain &quot;priority&quot;)[
		(set: _npcResultRule&#39;s priority to 0)
	]
	(if:_pcResultRule&#39;s priority &gt;= _npcResultRule&#39;s priority)[
		(set: _gameState to (_cmRollResultApp:
			_gameState,
			_pcResultRule&#39;s effects
		))
		(set: _gameState to ($cmGameRotate:(_cmRollResultApp:
			($cmGameRotate:_gameState),
			_npcResultRule&#39;s effects
		)))
	](else:)[
		(set: _gameState to ($cmGameRotate:(_cmRollResultApp:
			($cmGameRotate:_gameState),
			_npcResultRule&#39;s effects
		)))
		(set: _gameState to (_cmRollResultApp:
			_gameState,
			_pcResultRule&#39;s effects
		))
	]
(output:)[
	(if:_gameState&#39;s position is in $arGameoverPositions
		or _gameState&#39;s opponent&#39;s position is in $arGameoverPositions
	)[
		($cmGameoverUI:
			_gameState,
			(dm:
				&quot;endKind&quot;,&quot;result&quot;,
				&quot;pcResult&quot;,_pcResultRule,
				&quot;pcPosition&quot;,_gameState&#39;s position,
				&quot;npcResult&quot;,_npcResultRule,
				&quot;npcPosition&quot;,_gameState&#39;s opponent&#39;s position
			)
		)
	](else:)[
		(_cmGameUI:_gameState)
	]
]
]))</tw-passagedata><tw-passagedata pid="32" name="01 Result Rules" tags="startup" position="300,300" size="100,100">{=
(set: $arResultRules to (a:))</tw-passagedata><tw-passagedata pid="33" name="03 Result Rules Formatting" tags="startup" position="700,500" size="100,100">{=
(set: $arResultRules to (altered:
	_rule via _rule + (dm:&quot;diceResults&quot;,(altered:
		_diceResult via (sorted:..._diceResult),
		..._rule&#39;s diceResults
	)),
	...$arResultRules
))</tw-passagedata></tw-storydata>

